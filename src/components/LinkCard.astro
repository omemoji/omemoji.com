---
import { getImage } from "astro:assets";
import fetchMeta from "@/lib/fetchMeta";

interface Props {
  href: string;
}
const { href } = Astro.props;

const shortenURL = (url: string) => {
  const starts = url.indexOf("/") + 2;
  const leftShortenURL = url.substring(starts);
  const ends = leftShortenURL.indexOf("/");
  const URL = ends !== -1 ? leftShortenURL.substring(0, ends) : leftShortenURL;
  return URL;
};

const { title, description, image } = await fetchMeta(href);

// Astroで画像最適化を試み、失敗時（429, リダイレクト等）は元URLにフォールバック
let optimizedImage: {
  src: string;
  attributes: Record<string, string | number | undefined>;
} | null = null;
if (image.url !== "") {
  try {
    const result = await getImage({
      src: image.url,
      width: Math.round((image.width * 120) / image.height),
      height: 120,
      quality: 30,
    });
    optimizedImage = result;
  } catch (error) {
    optimizedImage = null;
  }
}
---

<div class="my-6">
  <a href={href} target="_blank" rel="noopener" class="hover:no-underline">
    <div
      class="hover:bg-gray-400/30 pl-1 transition-colors w-full h-25.5 rounded-lg border-solid border border-(--border) flex"
    >
      <div class="p-4 pr-0 flex overflow-hidden flex-col mr-auto w-full">
        <div
          class="text-(--fg) whitespace-nowrap xs:text-lg font-bold overflow-hidden text-ellipsis"
        >
          {title}{" "}
        </div>
        <div
          class="text-(--quote) whitespace-nowrap text-sm overflow-hidden m-0 text-ellipsis"
        >
          {description}
        </div>
        <div
          class="text-(--link) whitespace-nowrap overflow-hidden mb-0 mt-auto pb-0 text-sm text-ellipsis"
        >
          {shortenURL(href)}
        </div>
      </div>

      {
        image.url !== "" && optimizedImage ? (
          <img
            src={optimizedImage.src}
            width={optimizedImage.attributes.width}
            height={optimizedImage.attributes.height}
            alt=""
            loading="lazy"
            class="h-25 max-w-30 xs:max-w-60 w-auto m-0 rounded-r-lg object-cover"
          />
        ) : image.url !== "" ? (
          <img
            src={image.url}
            width={(image.width * 120) / image.height}
            height={120}
            alt=""
            loading="lazy"
            class="h-25 max-w-30 xs:max-w-60 w-auto m-0 rounded-r-lg object-cover"
          />
        ) : null
      }
    </div>
  </a>
</div>
